import{u as j,r as p,a as f,bl as I,bH as L}from"./index.c5429249.js";import{_ as v,l as h}from"./lodash.084a01e7.js";import{k as M,h as G,a as R}from"./index.cc06751b.js";import{q as b}from"./index.fd50cc71.js";import{a as k}from"./index.8ea7b56a.js";import{l as N}from"./index.c537589f.js";import{s as $}from"./index.5926f13f.js";import{s as m}from"./service.0215c8a4.js";import{p as F}from"./common.145f2eef.js";import{f as u}from"./index.a2051d72.js";const re=()=>{const{t:e}=j(),o=new Date,i=o.getFullYear(),a=o.getMonth(),c=o.getDate(),n=p({importFormRef:f(),importForm:{name:"",file:""},saving:!1,importRules:{file:{required:!0,trigger:["input","blur"],validator(){if(n.importForm.name==="")return new Error(e("project.workflow.enter_name_tips"))}}}}),d=p({startFormRef:f(),startForm:{processDefinitionCode:-1,startEndTime:[new Date(i,a,c),new Date(i,a,c)],scheduleTime:null,failureStrategy:"CONTINUE",warningType:"NONE",warningGroupId:null,execType:"START_PROCESS",startNodeList:"",taskDependType:"TASK_POST",complementDependentMode:"OFF_MODE",runMode:"RUN_MODE_SERIAL",processInstancePriority:"MEDIUM",workerGroup:"default",environmentCode:null,startParams:null,expectedParallelismNumber:"",dryRun:0},saving:!1}),g=p({timingFormRef:f(),timingForm:{startEndTime:[new Date(i,a,c),new Date(i+100,a,c)],crontab:"0 0 * * * ? *",timezoneId:Intl.DateTimeFormat().resolvedOptions().timeZone,failureStrategy:"CONTINUE",warningType:"NONE",processInstancePriority:"MEDIUM",warningGroupId:null,workerGroup:"default",environmentCode:null},saving:!1}),l=p({copyFormRef:f(),copyForm:{projectCode:null},saving:!1,copyRules:{projectCode:{required:!0,trigger:["input","blur"],validator(){if(l.copyForm.projectCode==="")return new Error(e("project.workflow.project_name_required"))}}}});return{importState:n,startState:d,timingState:g,copyState:l}};function oe(e,o){return m({url:`/projects/${o}/schedules`,method:"get",params:e})}function H(e,o){return m({url:`/projects/${o}/schedules`,method:"post",data:e})}function O(e,o){return m({url:`/projects/${o}/schedules/preview`,method:"post",data:e})}function _(e,o,i){return m({url:`/projects/${o}/schedules/${i}`,method:"put",data:e})}function te(e,o){return m({url:`/projects/${o}/schedules/${e}`,method:"delete",params:{scheduleId:e}})}function ne(e,o){return m({url:`/projects/${e}/schedules/${o}/offline`,method:"post"})}function ie(e,o){return m({url:`/projects/${e}/schedules/${o}/online`,method:"post"})}function se(e,o){const{t:i}=j(),a=I(),c=L(),n=p({projectCode:Number(c.params.projectCode),workerGroups:[],alertGroups:[],environmentList:[],startParamsList:[],schedulePreviewList:[]}),d={},g=()=>{e.importForm.name="",e.importForm.file=""},l=async()=>{if(await e.importFormRef.validate(),!e.saving){e.saving=!0;try{const t=new FormData;t.append("file",e.importForm.file);const r=Number(a.currentRoute.value.params.projectCode);await M(t,r),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show"),g()}catch{e.saving=!1}}},T=async t=>{if(await e.startFormRef.validate(),!e.saving){e.saving=!0;try{if(e.startForm.processDefinitionCode=t,e.startForm.startEndTime){const s=u(new Date(e.startForm.startEndTime[0]),"yyyy-MM-dd HH:mm:ss"),w=u(new Date(e.startForm.startEndTime[1]),"yyyy-MM-dd HH:mm:ss");e.startForm.scheduleTime=`${s},${w}`}const r={};for(const s of n.startParamsList)s.value!==""&&(r[s.prop]=s.value);e.startForm.startParams=v.isEmpty(r)?"":JSON.stringify(r),await $(e.startForm,n.projectCode),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show")}catch{e.saving=!1}}},C=async t=>{if(await e.timingFormRef.validate(),!e.saving){e.saving=!0;try{const r=y();r.processDefinitionCode=t,await H(r,n.projectCode),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show")}catch{e.saving=!1}}},D=async t=>{if(await e.timingFormRef.validate(),!e.saving){e.saving=!0;try{const r=y();r.id=t,await _(r,n.projectCode,t),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show")}catch{e.saving=!1}}},P=async t=>{if(await e.copyFormRef.validate(),!e.saving){e.saving=!0;try{const r={codes:v.join(t,","),targetProjectCode:e.copyForm.projectCode};await G(r,n.projectCode),window.$message.success(i("project.workflow.success")),e.saving=!1,o.emit("updateList"),o.emit("update:show"),e.copyForm.projectCode=""}catch{e.saving=!1}}},y=()=>{const t=u(F(e.timingForm.startEndTime[0]),"yyyy-MM-dd HH:mm:ss"),r=u(F(e.timingForm.startEndTime[1]),"yyyy-MM-dd HH:mm:ss");return{schedule:JSON.stringify({startTime:t,endTime:r,crontab:e.timingForm.crontab,timezoneId:e.timingForm.timezoneId}),failureStrategy:e.timingForm.failureStrategy,warningType:e.timingForm.warningType,processInstancePriority:e.timingForm.processInstancePriority,warningGroupId:e.timingForm.warningGroupId?e.timingForm.warningGroupId:0,workerGroup:e.timingForm.workerGroup,environmentCode:e.timingForm.environmentCode}};return{variables:n,handleImportDefinition:l,handleStartDefinition:T,handleCreateTiming:C,handleUpdateTiming:D,handleBatchCopyDefinition:P,getWorkerGroups:()=>{b().then(t=>{n.workerGroups=t.map(r=>({label:r,value:r}))})},getAlertGroups:()=>{N().then(t=>{n.alertGroups=t.map(r=>({label:r.groupName,value:r.id}))})},getEnvironmentList:()=>{k().then(t=>{n.environmentList=t.map(r=>({label:r.name,value:r.code,workerGroups:r.workerGroups}))})},getStartParamsList:t=>{if(d[t]){n.startParamsList=h.exports.cloneDeep(d[t]);return}R(t,n.projectCode).then(r=>{n.startParamsList=r.processDefinition.globalParamList,d[t]=h.exports.cloneDeep(n.startParamsList)})},getPreviewSchedule:()=>{e.timingFormRef.validate(async t=>{if(!t){const r=Number(a.currentRoute.value.params.projectCode),s=u(new Date(e.timingForm.startEndTime[0]),"yyyy-MM-dd HH:mm:ss"),w=u(new Date(e.timingForm.startEndTime[1]),"yyyy-MM-dd HH:mm:ss"),S=JSON.stringify({startTime:s,endTime:w,crontab:e.timingForm.crontab,timezoneId:e.timingForm.timezoneId});O({schedule:S},r).then(E=>{n.schedulePreviewList=E})}})}}}export{se as a,ne as b,te as d,ie as o,oe as q,re as u};
