import{l as D}from"./lodash.084a01e7.js";import{u as w,r as b,a as h,d as O,w as N,o as q,t as P,c as d}from"./index.c5429249.js";import{s as L}from"./service.0215c8a4.js";import{v as E,u as M,c as S}from"./index.847867b6.js";import{M as V}from"./index.20e11ec3.js";import{F as B,g as j}from"./get-elements-by-json.3336e937.js";import{N as A}from"./Input.97d5419b.js";import{a as J}from"./Select.e833ee40.js";import"./index.3b9f9e63.js";import"./Button.c43a24dc.js";import"./is-browser.d3e5def6.js";import"./use-rtl.c78ffbd8.js";import"./resolve-slot.7c241306.js";import"./keysOf.963e6f6c.js";import"./Card.c707a1eb.js";import"./index.16077d24.js";import"./index.3e01cddc.js";import"./flatten.a7868693.js";import"./Scrollbar.12b40993.js";import"./fade-in.cssr.9da325c6.js";import"./VResizeObserver.14b04bb7.js";import"./fade-in-scale-up.cssr.05526022.js";import"./utils.3eee947a.js";import"./Space.e50db48f.js";import"./get-slot.c85d6606.js";import"./Form.13999875.js";import"./FormItem.51e71cc3.js";import"./format-length.e7c2072e.js";import"./Grid.b73d23e7.js";import"./next-frame-once.da993024.js";import"./Spin.1e9405a1.js";import"./use-compitable.b0459e69.js";import"./Radio.5a2a0c2a.js";import"./RadioGroup.47f9a37a.js";import"./index.31fbc8bd.js";import"./DeleteOutlined.e68b06d7.js";import"./Switch.9ad161ba.js";import"./InputNumber.d8a1dfa4.js";import"./use-locale.be539345.js";import"./Add.e846b00c.js";import"./Checkbox.7506e5f5.js";import"./TreeSelect.b9641da1.js";import"./Selection.a106a9c5.js";import"./Popover.df2981b4.js";import"./Suffix.9ee1fead.js";function T(n){return L({url:"/ui-plugins/query-by-type",method:"get",params:n})}function x(n){return L({url:`/ui-plugins/${n}`,method:"get"})}function k(){const{t:n}=w(),s={instanceName:"",pluginDefineId:null},e=b({detailFormRef:h(),detailForm:{...s},uiPlugins:[],pluginsLoading:!1,json:[]}),r={model:e.detailForm,requireMarkPlacement:"left",labelPlacement:"left",labelWidth:180,rules:{instanceName:{trigger:"input",required:!0,message:n("security.alarm_instance.alarm_instance_name_tips")},pluginDefineId:{trigger:["blur","change"],required:!0,validator(i,l){if(!l&&l!==0)return new Error(n("security.alarm_instance.select_plugin_tips"))}}}},a=async()=>{if(!e.pluginsLoading){e.pluginsLoading=!0;try{const i=await T({pluginType:"ALERT"});e.uiPlugins=i.map(l=>({label:l.pluginName,value:l.id})),e.pluginsLoading=!1}catch{e.pluginsLoading=!1}}};return{meta:r,state:e,setDetail:i=>{e.detailForm.instanceName=i.instanceName,e.detailForm.pluginDefineId=i.pluginDefineId,i.pluginInstanceParams&&(e.json=JSON.parse(i.pluginInstanceParams))},initForm:()=>{a()},resetForm:()=>{e.detailFormRef.resetValues({...s}),e.json=[]},getFormValues:()=>e.detailForm,changePlugin:async i=>{if(e.pluginsLoading)return;e.pluginsLoading=!0,e.detailForm.pluginDefineId=i;const{pluginParams:l}=await x(i);l&&(e.json=JSON.parse(l)),e.pluginsLoading=!1}}}function W(n){const s=b({saving:!1,loading:!1}),e=(a,o={})=>(a==null||a.forEach(t=>{const u=D.exports.isFunction(t)?t():t;u.value=o[u.field]}),JSON.stringify(a));return{status:s,createOrUpdate:async(a,o)=>{const t=n();if(s.saving)return!1;s.saving=!0;try{return(a==null?void 0:a.instanceName)!==t.instanceName&&await E({alertInstanceName:t.instanceName}),a!=null&&a.id?await M({alertPluginInstanceId:t.pluginDefineId,instanceName:t.instanceName,pluginInstanceParams:e(o,t)},a.id):await S({instanceName:t.instanceName,pluginDefineId:t.pluginDefineId,pluginInstanceParams:e(o,t)}),s.saving=!1,!0}catch{return s.saving=!1,!1}}}}const $={show:{type:Boolean,default:!1},currentRecord:{type:Object,default:{}}},Be=O({name:"DetailModal",props:$,emits:["cancel","update"],setup(n,s){const{t:e}=w(),r=h({}),a=h([]),{meta:o,state:t,setDetail:u,initForm:g,resetForm:c,getFormValues:i,changePlugin:l}=k(),{status:f,createOrUpdate:y}=W(i),m=()=>{c(),r.value={},a.value=[],s.emit("cancel")},p=async()=>{await t.detailFormRef.validate(),await y(n.currentRecord,t.json)&&(m(),s.emit("update"))},U=l;return N(()=>n.show,async()=>{n.show&&n.currentRecord&&u(n.currentRecord)}),N(()=>t.json,()=>{var I;if(!((I=t.json)!=null&&I.length))return;t.json.forEach(_=>{const v=D.exports.isFunction(_)?_():_;v.name=e("security.alarm_instance."+v.field)});const{rules:F,elements:C}=j(t.json,t.detailForm);r.value=F,a.value=C}),q(()=>{g()}),{t:e,...P(t),...P(f),meta:o,rules:r,elements:a,onChangePlugin:U,onSubmit:p,onCancel:m}},render(n){const{show:s,t:e,meta:r,rules:a,elements:o,detailForm:t,uiPlugins:u,pluginsLoading:g,loading:c,saving:i,onChangePlugin:l,onCancel:f,onSubmit:y}=this,{currentRecord:m}=n;return d(V,{show:s,title:e(m!=null&&m.id?"security.alarm_instance.edit_alarm_instance":"security.alarm_instance.create_alarm_instance"),onConfirm:y,confirmLoading:i||c,onCancel:f},{default:()=>d(B,{ref:"detailFormRef",loading:c||g,meta:{...r,rules:{...r.rules,...a},elements:[{path:"instanceName",label:e("security.alarm_instance.alarm_instance_name"),widget:d(A,{value:t.instanceName,"onUpdate:value":p=>t.instanceName=p,placeholder:e("security.alarm_instance.alarm_instance_name_tips")},null)},{path:"pluginDefineId",label:e("security.alarm_instance.select_plugin"),widget:d(J,{value:t.pluginDefineId,"onUpdate:value":p=>t.pluginDefineId=p,options:u,disabled:!!(m!=null&&m.id),placeholder:e("security.alarm_instance.select_plugin_tips"),"on-update:value":l},null)},...o]},layout:{cols:24}},null)})}});export{Be as default};
