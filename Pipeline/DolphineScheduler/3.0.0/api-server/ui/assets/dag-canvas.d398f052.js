import{S as w}from"./dag.module.868c5c8a.js";import{G as v}from"./track.558e9151.js";import{a as O,X as y,N as C,E as S,b as x,c as A,P,d as b,e as M,f as H,g as R,h as I}from"./dag-config.11d87af9.js";import{l as G,_ as a}from"./lodash.084a01e7.js";import{a as z}from"./index.075b615e.js";import V from"./dag-context-menu.87eb6a4b.js";import{a as E,o as T,d as X,n as k,c as L}from"./index.c5429249.js";import"./gForce.96ee147a.js";import"./service.0215c8a4.js";import"./dag-node-status.4be2745c.js";import"./task-node.0b2752c6.js";import"./toNumber.5d1af176.js";import"./Popover.df2981b4.js";import"./index.3e01cddc.js";import"./flatten.a7868693.js";import"./Scrollbar.12b40993.js";import"./fade-in.cssr.9da325c6.js";import"./VResizeObserver.14b04bb7.js";import"./format-length.e7c2072e.js";import"./utils.3eee947a.js";import"./resolve-slot.7c241306.js";import"./use-compitable.b0459e69.js";import"./next-frame-once.da993024.js";import"./debounce.b14aac0d.js";import"./index.bdf8fa15.js";import"./common.145f2eef.js";import"./SettingOutlined.716a0298.js";import"./PauseCircleOutlined.813adbbb.js";import"./CloseCircleOutlined.46c86330.js";import"./CheckCircleOutlined.6daee0ce.js";import"./EditOutlined.af3970b8.js";import"./ClockCircleOutlined.6c97131a.js";import"./index.a2051d72.js";import"./Button.c43a24dc.js";import"./is-browser.d3e5def6.js";import"./use-rtl.c78ffbd8.js";import"./Icon.8e3bf5ec.js";import"./Spin.1e9405a1.js";import"./index.16077d24.js";import"./Tooltip.d759bd4b.js";function $(D){const{readonly:l,graph:r}=D,m=E(),p=E(),i=E();function u(){return v.registerNodeTool("contextmenu",V,!0),new v({container:m.value,selecting:{enabled:!0,multiple:!0,rubberband:!0,rubberEdge:!0,movable:!0,showNodeSelectionBox:!1},scaling:{min:.2,max:2},mousewheel:{enabled:!0,modifiers:["ctrl","meta"]},scroller:!0,grid:{size:10,visible:!0},snapline:!0,minimap:{enabled:!0,container:p.value,scalable:!1,width:200,height:120},interacting:{edgeLabelMovable:!1,nodeMovable:!l.value,magnetConnectable:!l.value},connecting:{allowMulti:!1,allowBlank:!1,allowLoop:!1,allowEdge:!1,allowNode:!0,allowPort:!1,highlight:!0,createEdge(){var t;return(t=r.value)==null?void 0:t.createEdge({shape:O})},validateConnection(t){var c;const{sourceCell:o,targetCell:n}=t;if(o&&n&&o.isNode()&&n.isNode()){const d=o.getData();if(!d||d.taskType!=="CONDITIONS")return!0;const h=(c=r.value)==null?void 0:c.getConnectedEdges(o);if(!h||h.length<2)return!0;let g=0;return!h.some(f=>(f.getSourceCellId()===o.id&&g++,g>2))}return!0}},highlighting:{nodeAvailable:{name:"className",args:{className:"available"}},magnetAvailable:{name:"className",args:{className:"available"}},magnetAdsorbed:{name:"className",args:{className:"adsorbed"}}}})}T(()=>{r.value=u(),r.value.on("edge:connected",({isNew:t,edge:o})=>{if(t){const n=o.getSourceNode();o.setSource(n)}}),r.value.on("node:mouseenter",({node:t})=>{const o=t.getData().taskName,c=t.getMarkup().filter(d=>d.tagName==="foreignObject")[0];t.addTools({name:"button",args:{markup:[{tagName:"text",textContent:o,attrs:{fill:"#868686","font-size":16,"text-anchor":"center"}}],x:0,y:0,offset:{x:0,y:c?-28:-10}}})}),r.value.on("node:mouseleave",({node:t})=>{t.removeTool("button")})});const e=G.exports.debounce(()=>{var t;if(i.value){const o=i.value.offsetWidth,n=i.value.offsetHeight;(t=r.value)==null||t.resize(o,n)}},200);z(i,e);function s(){v.unregisterNode(y),v.unregisterEdge(O),v.registerNode(y,{...C}),v.registerEdge(O,{...S})}return T(()=>{s()}),{graph:r,paper:m,minimap:p,container:i}}function B(D){const{graph:l}=D,r=E(),m=e=>e?e.toLocaleLowerCase()==="em"||e.toLocaleLowerCase()==="body":!1;function p(e){var n;const s=e===r.value,t=(n=l.value)==null?void 0:n.isSelected(e);let o=null;s?o=a.merge(a.cloneDeep(S),x):t?o=a.merge(a.cloneDeep(S),A):o=a.cloneDeep(S),e.setAttrs(o.attrs),e.setLabels([{...a.merge({attrs:a.cloneDeep(o.defaultLabel.attrs)})}])}function i(e){var _;const s=e===r.value,t=(_=l.value)==null?void 0:_.isSelected(e),o=a.cloneDeep(P.groups[b].attrs),n=a.cloneDeep(M.groups[b].attrs),c=a.cloneDeep(H.groups[b].attrs),d=a.merge(a.cloneDeep(C.attrs),R.attrs),h=a.merge(a.cloneDeep(C.attrs),I.attrs);let g=null,f=null,N=null;s||t?(g=`/dolphinscheduler/ui/images/task-icons/${e.data.taskType.toLocaleLowerCase()}_hover.png`,s?(f=d,N=a.merge(c,o)):(f=h,N=a.merge(c,n))):(g=`/dolphinscheduler/ui/images/task-icons/${e.data.taskType.toLocaleLowerCase()}.png`,f=C.attrs,N=c),e.setAttrByPath("image/xlink:href",g),e.setAttrs(f),e.setPortProp(b,"attrs",N)}function u(e){e.isEdge()?p(e):e.isNode()&&i(e)}return T(()=>{l.value&&(l.value.on("cell:mouseenter",e=>{const{cell:s,e:t}=e;m(t.target.tagName)||(r.value=s,u(s))}),l.value.on("cell:mouseleave",({cell:e})=>{r.value=void 0,u(e)}),l.value.on("cell:selected",({cell:e})=>{u(e)}),l.value.on("cell:unselected",({cell:e})=>{u(e)}))}),{hoverCell:r}}var ke=X({name:"workflow-dag-canvas",emits:["drop"],setup(D,l){const r=k("readonly",E(!1)),m=k("graph",E()),{paper:p,minimap:i,container:u}=$({readonly:r,graph:m});B({graph:m});const e=s=>{s.preventDefault()};return()=>L("div",{ref:u,class:[w.canvas,"dag-container"],onDrop:s=>{l.emit("drop",s)},onDragenter:e,onDragover:e,onDragleave:e},[L("div",{ref:p,class:w.paper},null),L("div",{ref:i,class:w.minimap},null)])}});export{ke as default};
