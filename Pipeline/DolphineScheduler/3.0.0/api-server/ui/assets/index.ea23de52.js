import{d as j,bB as L,bz as P,bA as W,u as w,bH as R,h as o,r as M,a as u,o as V,w as x,t as _,c as i,_ as U,a2 as B}from"./index.c5429249.js";import{u as H}from"./index.075b615e.js";import{B as q}from"./index.3b9f9e63.js";import{d as J,q as A,u as F,s as $,a as G,g as K}from"./index.bdf8fa15.js";import{C as c,c as X,D as Y}from"./column-width-config.63466f21.js";import{E as Q}from"./EditOutlined.af3970b8.js";import{E as Z}from"./ExclamationCircleOutlined.e3fe8f60.js";import{D as ee}from"./DeleteOutlined.e68b06d7.js";import{a as te}from"./Dropdown.749e9383.js";import{d as v}from"./Selection.a106a9c5.js";import{N as T}from"./Tooltip.d759bd4b.js";import{N as h}from"./Button.c43a24dc.js";import{N as g}from"./Icon.8e3bf5ec.js";import{N as ae}from"./Popconfirm.83d41c5f.js";import{N as z}from"./Space.e50db48f.js";import{f as oe,N as se}from"./detail-modal.30928b47.js";import{T as re}from"./task-type.1f698d1a.js";import{C as ie}from"./index.97f03277.js";import ne from"./version-modal.a9655ff9.js";import le from"./move-modal.1565ad92.js";import{S as pe}from"./SearchOutlined.5b629110.js";import{N as ce}from"./Card.c707a1eb.js";import{N as D}from"./Input.97d5419b.js";import{a as me}from"./Select.e833ee40.js";import{N as ue,a as de}from"./DataTable.d85b2298.js";import"./service.0215c8a4.js";import"./lodash.084a01e7.js";import"./Popover.df2981b4.js";import"./index.3e01cddc.js";import"./flatten.a7868693.js";import"./Scrollbar.12b40993.js";import"./fade-in.cssr.9da325c6.js";import"./VResizeObserver.14b04bb7.js";import"./format-length.e7c2072e.js";import"./utils.3eee947a.js";import"./resolve-slot.7c241306.js";import"./use-compitable.b0459e69.js";import"./next-frame-once.da993024.js";import"./ChevronRight.f70a9c2d.js";import"./fade-in-scale-up.cssr.05526022.js";import"./use-keyboard.22724d1e.js";import"./index.16077d24.js";import"./use-locale.be539345.js";import"./use-rtl.c78ffbd8.js";import"./Suffix.9ee1fead.js";import"./is-browser.d3e5def6.js";import"./keysOf.963e6f6c.js";import"./get-slot.c85d6606.js";import"./index.20e11ec3.js";import"./detail.d1a94623.js";import"./get-elements-by-json.3336e937.js";import"./Form.13999875.js";import"./FormItem.51e71cc3.js";import"./Grid.b73d23e7.js";import"./Spin.1e9405a1.js";import"./Radio.5a2a0c2a.js";import"./RadioGroup.47f9a37a.js";import"./index.31fbc8bd.js";import"./Switch.9ad161ba.js";import"./InputNumber.d8a1dfa4.js";import"./Add.e846b00c.js";import"./Checkbox.7506e5f5.js";import"./TreeSelect.b9641da1.js";import"./ArrowUpOutlined.a96a5df0.js";import"./index.fd50cc71.js";import"./index.8ea7b56a.js";import"./index.bbd47aff.js";import"./task-node.0b2752c6.js";import"./index.cc06751b.js";import"./index.8259a597.js";import"./index.3b5bce66.js";import"./index.c537589f.js";import"./index.bbb6cfa3.js";import"./common.145f2eef.js";import"./SettingOutlined.716a0298.js";import"./PauseCircleOutlined.813adbbb.js";import"./CloseCircleOutlined.46c86330.js";import"./CheckCircleOutlined.6daee0ce.js";import"./ClockCircleOutlined.6c97131a.js";import"./index.a2051d72.js";import"./index.650fd948.js";import"./index.31c70196.js";import"./ProfileOutlined.be3098c4.js";import"./ArrowDown.db19052e.js";import"./Forward.23552619.js";const ke={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 1024 1024"},fe=W("path",{d:"M909.3 506.3L781.7 405.6a7.23 7.23 0 0 0-11.7 5.7V476H548V254h64.8c6 0 9.4-7 5.7-11.7L517.7 114.7a7.14 7.14 0 0 0-11.3 0L405.6 242.3a7.23 7.23 0 0 0 5.7 11.7H476v222H254v-64.8c0-6-7-9.4-11.7-5.7L114.7 506.3a7.14 7.14 0 0 0 0 11.3l127.5 100.8c4.7 3.7 11.7.4 11.7-5.7V548h222v222h-64.8c-6 0-9.4 7-5.7 11.7l100.8 127.5c2.9 3.7 8.5 3.7 11.3 0l100.8-127.5c3.7-4.7.4-11.7-5.7-11.7H548V548h222v64.8c0 6 7 9.4 11.7 5.7l127.5-100.8a7.3 7.3 0 0 0 .1-11.4z",fill:"currentColor"},null,-1),he=[fe];var ge=j({name:"DragOutlined",render:function(a,l){return L(),P("svg",ke,he)}});function Te(n){const{t:a}=w(),l=R(),m=Number(l.params.projectCode),d=t=>{t.columns=[{title:"#",key:"index",render:(e,p)=>p+1,...c.index},{title:a("project.task.task_name"),key:"taskName",...c.linkName,render:e=>o(q,{onClick:()=>void n(e,!0)},{default:()=>o(te,c.linkEllipsis,()=>e.taskName)})},{title:a("project.task.workflow_name"),key:"processDefinitionName",...c.name},{title:a("project.task.workflow_state"),key:"processReleaseState",render:e=>{if(e.processReleaseState==="OFFLINE")return o(v,{type:"error",size:"small"},()=>a("project.task.offline"));if(e.processReleaseState==="ONLINE")return o(v,{type:"info",size:"small"},()=>a("project.task.online"))},width:130},{title:a("project.task.task_type"),key:"taskType",...c.type},{title:a("project.task.version"),key:"taskVersion",render:e=>o("span",null,"v"+e.taskVersion),...c.version},{title:a("project.task.upstream_tasks"),key:"upstreamTaskMap",render:e=>e.upstreamTaskMap.map((p,s)=>o("p",null,{default:()=>`[${s+1}] ${p}`})),...c.name},{title:a("project.task.create_time"),key:"taskCreateTime",...c.time},{title:a("project.task.update_time"),key:"taskUpdateTime",...c.time},{title:a("project.task.operation"),key:"operation",...c.operation(4),render(e){return o(z,null,{default:()=>[o(T,{},{trigger:()=>o(h,{circle:!0,type:"info",size:"small",disabled:["CONDITIONS","SWITCH"].includes(e.taskType)||!!e.processDefinitionCode&&e.processReleaseState==="ONLINE",onClick:()=>{n(e,!1)}},{icon:()=>o(g,null,{default:()=>o(Q)})}),default:()=>a("project.task.edit")}),o(T,{},{trigger:()=>o(h,{circle:!0,type:"info",size:"small",disabled:!!e.processDefinitionCode&&e.processReleaseState==="ONLINE",onClick:()=>{t.showMoveModalRef=!0,t.row=e}},{icon:()=>o(g,null,{default:()=>o(ge)})}),default:()=>a("project.task.move")}),o(T,{},{trigger:()=>o(h,{circle:!0,type:"info",size:"small",onClick:()=>{t.showVersionModalRef=!0,t.row=e}},{icon:()=>o(g,null,{default:()=>o(Z)})}),default:()=>a("project.task.version")}),o(ae,{onPositiveClick:()=>{f(e)}},{trigger:()=>o(T,{},{trigger:()=>o(h,{circle:!0,type:"error",size:"small",disabled:!!e.processDefinitionCode&&e.processReleaseState==="ONLINE"},{icon:()=>o(g,null,{default:()=>o(ee)})}),default:()=>a("project.task.delete")}),default:()=>a("project.task.delete_confirm")})]})}}],t.tableWidth&&(t.tableWidth=X(t.columns))},r=M({columns:[],tableWidth:Y,tableData:[],page:u(1),pageSize:u(10),searchTaskName:u(null),searchWorkflowName:u(null),totalPage:u(1),taskType:u(null),showVersionModalRef:u(!1),showMoveModalRef:u(!1),row:{},loadingRef:u(!1)}),f=t=>{J({code:t.taskCode},{projectCode:m}).then(()=>{k({pageSize:r.pageSize,pageNo:r.tableData.length===1&&r.page>1?r.page-1:r.page,searchTaskName:r.searchTaskName,searchWorkflowName:r.searchWorkflowName,taskType:r.taskType})})},k=t=>{if(r.loadingRef)return;r.loadingRef=!0;const{state:e}=H(A({...t},{projectCode:m}).then(p=>{r.tableData=p.totalList.map((s,S)=>(Object.keys(s.upstreamTaskMap).length>0?s.upstreamTaskMap=Object.keys(s.upstreamTaskMap).map(N=>s.upstreamTaskMap[N]):s.upstreamTaskMap=[],{...s})),r.totalPage=p.totalPage,r.loadingRef=!1}),{});return e};return{variables:r,getTableData:k,createColumns:d}}function Ne(n){const a={taskType:"SHELL"},l=M({taskShow:!1,taskData:{...a},taskSaving:!1,taskReadonly:!1}),m=(e,p)=>{const s=oe(e);return p?{processDefinitionCode:s.processDefinitionCode,upstreamCodes:s.upstreamCodes,taskDefinitionJsonObj:JSON.stringify(s.taskDefinitionJsonObj)}:{upstreamCodes:s.upstreamCodes,taskDefinitionJsonObj:JSON.stringify(s.taskDefinitionJsonObj)}},d=async()=>(await K(1,n))[0];return{task:l,onToggleShow:e=>{l.taskShow=e},onTaskSave:async e=>{if(!l.taskSaving){l.taskSaving=!0;try{if(e.id)e.code&&await F(n,e.code,m({...e,code:e.code},!1));else{const p=await d();await $(n,m({...e,code:p},!0))}return l.taskSaving=!1,!0}catch{return l.taskSaving=!1,!1}}},onEditTask:async(e,p)=>{const s=await G(e.taskCode,n);l.taskData={...s,processName:e.processDefinitionCode},l.taskShow=!0,l.taskReadonly=p},onInitTask:()=>{l.taskData={...a},l.taskReadonly=!1}}}const ye="_box_a2wen_22",we="_pagination_a2wen_36";var y={"search-card":"_search-card_a2wen_17",box:ye,"table-card":"_table-card_a2wen_33",pagination:we};function Se(n){return typeof n=="function"||Object.prototype.toString.call(n)==="[object Object]"&&!U(n)}const ta=j({name:"task-definition",setup(){const n=R(),a=Number(n.params.projectCode),{t:l}=w(),{task:m,onToggleShow:d,onTaskSave:r,onEditTask:f,onInitTask:k}=Ne(a),{variables:t,getTableData:e,createColumns:p}=Te(f),s=()=>{e({pageSize:t.pageSize,pageNo:t.page,searchTaskName:t.searchTaskName,searchWorkflowName:t.searchWorkflowName,taskType:t.taskType})},S=()=>{t.page=1,s()},N=()=>{t.page=1,s()},C=()=>{t.showVersionModalRef=!1,t.showMoveModalRef=!1,s()},O=()=>{d(!0)},b=()=>{d(!1),k()},E=async I=>{await r(I.data)&&(b(),C())};return V(()=>{p(t),s()}),x(w().locale,()=>{p(t)}),{t:l,..._(t),..._(m),onSearch:N,requestData:s,onUpdatePageSize:S,onRefresh:C,onCreate:O,onTaskSubmit:E,onTaskCancel:b,projectCode:a}},render(){let n;const{t:a,onSearch:l,requestData:m,onUpdatePageSize:d,onRefresh:r,onCreate:f,loadingRef:k}=this;return i(B,null,[i(ce,null,{default:()=>[i("div",{class:y["search-card"]},[i("div",null,[i(h,{size:"small",type:"primary",onClick:f},Se(n=a("project.task.create_task"))?n:{default:()=>[n]})]),i(z,{justify:"end"},{default:()=>[i(D,{size:"small",clearable:!0,value:this.searchTaskName,"onUpdate:value":t=>this.searchTaskName=t,placeholder:a("project.task.task_name")},null),i(D,{size:"small",clearable:!0,value:this.searchWorkflowName,"onUpdate:value":t=>this.searchWorkflowName=t,placeholder:a("project.task.workflow_name")},null),i(me,{value:this.taskType,"onUpdate:value":t=>this.taskType=t,size:"small",options:Object.keys(re).map(t=>({value:t,label:t})),placeholder:a("project.task.task_type"),style:{width:"180px"},clearable:!0},null),i(h,{size:"small",type:"primary",onClick:l},{icon:()=>i(g,null,{default:()=>[i(pe,null,null)]})})]})])]}),i(ie,{class:y["table-card"]},{default:()=>[i(ue,{loading:k,columns:this.columns,data:this.tableData,scrollX:this.tableWidth},null),i("div",{class:y.pagination},[i(de,{page:this.page,"onUpdate:page":t=>this.page=t,"page-size":this.pageSize,"onUpdate:page-size":t=>this.pageSize=t,"page-count":this.totalPage,"show-size-picker":!0,"page-sizes":[10,30,50],"show-quick-jumper":!0,onUpdatePage:m,onUpdatePageSize:d},null)])]}),i(ne,{show:this.showVersionModalRef,row:this.row,onConfirm:()=>this.showVersionModalRef=!1,onRefresh:r},null),i(le,{show:this.showMoveModalRef,row:this.row,onCancel:()=>this.showMoveModalRef=!1,onRefresh:r},null),i(se,{show:this.taskShow,data:this.taskData,onSubmit:this.onTaskSubmit,onCancel:this.onTaskCancel,projectCode:this.projectCode,from:1,readonly:this.taskReadonly,saving:this.taskSaving},null)])}});export{ta as default};
