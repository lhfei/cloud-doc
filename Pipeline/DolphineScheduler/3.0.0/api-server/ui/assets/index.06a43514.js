import{br as $,w as x,a as L,bH as J,o as Q,r as pe,u as Z,h as ge,cm as ve,d as ke,aj as Te,C as z,B as j,j as Y,P as he,c as D}from"./index.c5429249.js";import Ce from"./dag-toolbar.bce8bd3d.js";import Ne from"./dag-canvas.d398f052.js";import Le from"./dag-sidebar.2b0704d9.js";import{S as G}from"./dag.module.868c5c8a.js";import{u as Se,D as ye}from"./dag-auto-layout-modal.c1130ec6.js";import"./track.558e9151.js";import{l as M}from"./lodash.084a01e7.js";import{u as De}from"./index.075b615e.js";import we from"./dag-context-menu.87eb6a4b.js";import"./gForce.96ee147a.js";import{a as Ee,X as Re,N as be,i as Me}from"./dag-config.11d87af9.js";import"./service.0215c8a4.js";import Ie from"./dag-node-status.4be2745c.js";import{u as xe}from"./task-node.0b2752c6.js";import{g as Ve}from"./index.bdf8fa15.js";import{f as Pe,N as Ae}from"./detail-modal.30928b47.js";import{T as Oe}from"./task-type.1f698d1a.js";import{t as _e}from"./common.145f2eef.js";import{c as je}from"./index.31c70196.js";import Ue from"./version-modal.cb9503da.js";import Be from"./dag-save-modal.494fac90.js";import Xe from"./start-modal.0937a5b5.js";import{L as He,q as Ye}from"./index.fc8088f4.js";/* empty css                 */import"./use-text-copy.51199844.js";import"./use-message.f235e8f1.js";import"./dag-startup-param.21037cf7.js";import"./index.c537589f.js";import"./index.fd50cc71.js";import"./SettingOutlined.716a0298.js";import"./PauseCircleOutlined.813adbbb.js";import"./CloseCircleOutlined.46c86330.js";import"./CheckCircleOutlined.6daee0ce.js";import"./EditOutlined.af3970b8.js";import"./ClockCircleOutlined.6c97131a.js";import"./index.a2051d72.js";import"./variables-view.f40e3ebd.js";import"./Button.c43a24dc.js";import"./is-browser.d3e5def6.js";import"./use-rtl.c78ffbd8.js";import"./resolve-slot.7c241306.js";import"./CopyOutlined.ff0f3037.js";import"./SearchOutlined.5b629110.js";import"./DownloadOutlined.8c21680b.js";import"./SyncOutlined.859a474f.js";import"./DeleteOutlined.e68b06d7.js";import"./FullscreenOutlined.135d7d35.js";import"./InfoCircleOutlined.9a8e087c.js";import"./Tooltip.d759bd4b.js";import"./Popover.df2981b4.js";import"./index.3e01cddc.js";import"./flatten.a7868693.js";import"./Scrollbar.12b40993.js";import"./fade-in.cssr.9da325c6.js";import"./VResizeObserver.14b04bb7.js";import"./format-length.e7c2072e.js";import"./utils.3eee947a.js";import"./use-compitable.b0459e69.js";import"./next-frame-once.da993024.js";import"./Icon.8e3bf5ec.js";import"./Selection.a106a9c5.js";import"./index.16077d24.js";import"./use-locale.be539345.js";import"./Suffix.9ee1fead.js";import"./text.6383fc2d.js";import"./Select.e833ee40.js";import"./fade-in-scale-up.cssr.05526022.js";import"./toNumber.5d1af176.js";import"./debounce.b14aac0d.js";import"./Spin.1e9405a1.js";import"./index.20e11ec3.js";import"./index.3b9f9e63.js";import"./keysOf.963e6f6c.js";import"./Card.c707a1eb.js";import"./Space.e50db48f.js";import"./get-slot.c85d6606.js";import"./Form.13999875.js";import"./FormItem.51e71cc3.js";import"./RadioGroup.47f9a37a.js";import"./RadioButton.2ddd4a35.js";import"./InputNumber.d8a1dfa4.js";import"./Input.97d5419b.js";import"./Add.e846b00c.js";import"./detail.d1a94623.js";import"./get-elements-by-json.3336e937.js";import"./Grid.b73d23e7.js";import"./Radio.5a2a0c2a.js";import"./index.31fbc8bd.js";import"./Switch.9ad161ba.js";import"./Checkbox.7506e5f5.js";import"./TreeSelect.b9641da1.js";import"./ArrowUpOutlined.a96a5df0.js";import"./index.8ea7b56a.js";import"./index.bbd47aff.js";import"./index.cc06751b.js";import"./index.8259a597.js";import"./index.3b5bce66.js";import"./index.bbb6cfa3.js";import"./index.650fd948.js";import"./ProfileOutlined.be3098c4.js";import"./use-modal.4eacfaef.js";import"./index.5926f13f.js";import"./ExclamationCircleOutlined.e3fe8f60.js";import"./Popconfirm.83d41c5f.js";import"./index.module.e21b9b67.js";import"./DataTable.d85b2298.js";import"./ArrowDown.db19052e.js";import"./Dropdown.749e9383.js";import"./ChevronRight.f70a9c2d.js";import"./use-keyboard.22724d1e.js";import"./Forward.23552619.js";import"./index.d81654bf.js";import"./ButtonGroup.437137c8.js";import"./DatePicker.fbb7ccb7.js";import"./throttle.754ed9e3.js";function Ge(){function n(s,g,m){const a={};g.forEach(t=>{const o=t.getTargetCellId();a[o]=!0});const c=t=>!a[t],k={};s.forEach(t=>{const o=t.id,r=m.find(u=>u.code===Number(o));r&&(k[o]=r)});const h=s.filter(t=>c(t.id)).map(t=>{const o=k[t.id];return{name:"",preTaskCode:0,preTaskVersion:0,postTaskCode:o.code,postTaskVersion:o.version||0,conditionType:"NONE",conditionParams:{}}}),i=g.map(t=>{const o=t.getLabels(),r=M.exports.get(o,["0","attrs","label","text"],""),u=t.getSourceCellId(),p=k[u],d=t.getTargetCellId(),N=k[d];return{name:r,preTaskCode:p.code,preTaskVersion:p.version||0,postTaskCode:N.code,postTaskVersion:N.version||0,conditionType:"NONE",conditionParams:{}}});return h.concat(i)}function l(s){return s.map(g=>{const m=+g.id,{x:a,y:c}=g.getPosition();return{taskCode:m,x:a,y:c}})}return{getLocations:l,getConnects:n}}function $e(n){const{graph:l}=n,{buildNode:s,buildEdge:g}=ee();function m(o,r){var p;const u=(p=l.value)==null?void 0:p.getCellById(o);if(u){const d=$.truncateText(r,18);u.attr("title/text",d),u.setData({taskName:r})}}function a(o,r,u,p,d={x:100,y:100}){var E;if(!Oe[r])return;const N=s(o,r,u,p,d);(E=l.value)==null||E.addNode(N)}function c(o){var r;(r=l.value)==null||r.removeNode(o)}const k=o=>{var p,d;const r=(p=l.value)==null?void 0:p.getCellById(o);return r?((d=l.value)==null?void 0:d.getConnectedEdges(r))||[]:[]};return{setNodeName:m,setNodeEdge:(o,r)=>{const u=k(o);u!=null&&u.length&&u.forEach(p=>{var d,N;((d=p.getTargetNode())==null?void 0:d.id)===o&&((N=l.value)==null||N.removeEdge(p))}),r.forEach(p=>{var d;(d=l.value)==null||d.addEdge(g(String(p),o))})},addNode:a,removeNode:c,getSources:o=>{const r=k(o);if(!r.length)return[];const u=[];return r.forEach(p=>{const d=p.getSourceNode();d&&d.id!==o&&u.push(Number(d.id))}),u},getTargets:o=>{const r=k(o);if(!r.length)return[];const u=[];return r.forEach(p=>{const d=p.getTargetNode();d&&d.id!==o&&u.push(Number(d.id))}),u}}}function ee(){function n(m){let a=null;return m?(a=JSON.parse(m),Array.isArray(a)?a:null):a}function l(m,a,c=""){return{shape:Ee,source:{cell:m},target:{cell:a},labels:c?[c]:void 0}}function s(m,a,c,k,h={x:100,y:100}){const i=c?$.truncateText(c,18):m;return{id:m,shape:Re,x:h.x,y:h.y,data:{taskType:a,taskName:c||m,flag:k},attrs:{image:{"xlink:href":`/dolphinscheduler/ui/images/task-icons/${a.toLocaleLowerCase()}.png`},title:{text:i},rect:{fill:k==="NO"?"#f3f3f5":"#ffffff"}}}}function g(m){const a=[],c=[],k=n(m.processDefinition.locations)||[],h=m.taskDefinitionList,i=m.processTaskRelationList;return h.forEach(t=>{const o=k.find(u=>u.taskCode===t.code)||{},r=s(t.code+"",t.taskType,t.name,t.flag,{x:o.x,y:o.y});a.push(r)}),i.filter(t=>!!t.preTaskCode).forEach(t=>{const o=l(t.preTaskCode+"",t.postTaskCode+"",t.name);c.push(o)}),{nodes:a,edges:c}}return{buildNode:s,buildEdge:l,buildGraph:g}}function Je(n){const{graph:l,definition:s}=n,{buildGraph:g}=ee();return x([l,s],()=>{l.value&&s.value&&l.value.fromJSON(g(s.value))}),{}}function qe(n){const{readonly:l,graph:s,appendTask:g}=n,m=J(),a=Number(m.params.projectCode),c=L({x:0,y:0,type:"SHELL"});function k(t,o){if(l.value){t.preventDefault();return}c.value={x:t.offsetX,y:t.offsetY,type:o}}function h(t){if(t.stopPropagation(),t.preventDefault(),!l.value&&c.value&&s.value&&a){const{type:o,x:r,y:u}=c.value,{x:p,y:d}=s.value.clientToLocal(t.clientX,t.clientY);Ve(1,a).then(E=>{const[I]=E;g(I,o,{x:p-r,y:d-u})})}}const i=t=>{t.preventDefault()};return{onDragStart:k,onDrop:h,onDragenter:i,onDragover:i,onDragleave:i}}function Fe(n){const{graph:l,definition:s}=n,{addNode:g,removeNode:m,getSources:a,getTargets:c,setNodeName:k,setNodeEdge:h}=$e({graph:l}),i=L((s==null?void 0:s.value)||{processDefinition:{},processTaskRelationList:[],taskDefinitionList:[]}),t=L({taskType:"SHELL",code:0,name:""}),o=L(!1);function r(e,T,f){g(e+"",T,"","YES",f),i.value.taskDefinitionList.push({code:e,taskType:T,name:""}),d({code:e,taskType:T,name:""})}function u(e,T,f,C,S,y){g(T+"",C,e,S,y);const U=i.value.taskDefinitionList.find(A=>A.code===f),P={...M.exports.cloneDeep(U),code:T,name:e};i.value.taskDefinitionList.push(P)}function p(e,T){i.value.taskDefinitionList=i.value.taskDefinitionList.filter(f=>!e.includes(f.code)),e.forEach(f=>{M.exports.remove(i.value.processTaskRelationList,C=>C.postTaskCode===f||C.preTaskCode===f)}),T==null||T.forEach(f=>{if(f.isEdge()){const C=f.getSourceCellId(),S=f.getTargetCellId();M.exports.remove(i.value.processTaskRelationList,y=>String(y.postTaskCode)===S&&String(y.preTaskCode)===C)}})}function d(e){t.value=e,o.value=!0}function N(e){const T=i.value.taskDefinitionList.find(f=>f.code===e);T&&(t.value=T),b(a(String(e)),e),V(e),o.value=!0}function E({data:e}){const T=Pe(e).taskDefinitionJsonObj;i.value.taskDefinitionList=i.value.taskDefinitionList.map(f=>{var C;return f.code===((C=t.value)==null?void 0:C.code)?(k(f.code+"",T.name),h(String(f.code),e.preTasks),b(e.preTasks,f.code),{...T,version:f.version,code:f.code,taskType:t.value.taskType,id:f.id}):f}),o.value=!1}function I(){o.value=!1,t.value.name||(m(String(t.value.code)),M.exports.remove(i.value.taskDefinitionList,e=>e.code===t.value.code))}function b(e,T){var f,C;(C=(f=i.value)==null?void 0:f.processTaskRelationList)!=null&&C.length&&M.exports.remove(i.value.processTaskRelationList,S=>S.postTaskCode===T),e!=null&&e.length&&e.forEach(S=>{var y;(y=i.value)==null||y.processTaskRelationList.push({postTaskCode:T,preTaskCode:S,name:"",preTaskVersion:1,postTaskVersion:1,conditionType:"NONE",conditionParams:{}})})}function V(e){c(String(e)).forEach(f=>{var C,S;(C=i.value)!=null&&C.processTaskRelationList.find(y=>y.postTaskCode===f&&y.preTaskCode===e)||(S=i.value)==null||S.processTaskRelationList.push({postTaskCode:f,preTaskCode:e,name:"",preTaskVersion:1,postTaskVersion:1,conditionType:"NONE",conditionParams:{}})})}return Q(()=>{l.value&&l.value.on("cell:dblclick",({cell:e})=>{const T=Number(e.id);N(T)})}),x(s,()=>{s.value&&(i.value=s.value)}),{currTask:t,taskModalVisible:o,processDefinition:i,taskConfirm:E,taskCancel:I,appendTask:r,editTask:N,copyTask:u,removeTasks:p}}function Ke(n){const{graph:l}=n,s=pe({menuVisible:!1,startModalShow:!1,logTaskId:-1,logTaskType:"",pageX:0,pageY:0,menuCell:{},showModalRef:L(!1),row:{},logRef:"",logLoadingRef:L(!0),skipLineNum:L(0),limit:L(1e3),taskCode:""}),g=()=>{var c;s.menuVisible=!1,(c=l.value)==null||c.unlockScroller()},m=c=>{s.startModalShow=!0,s.taskCode=String(c)},a=(c,k)=>{s.logTaskId=c,s.logTaskType=k,s.showModalRef=!0};return Q(()=>{l.value&&l.value.on("node:contextmenu",({cell:c,x:k,y:h})=>{s.menuCell=c;const i=l.value.localToPage(k,h);s.pageX=i.x,s.pageY=i.y,s.menuVisible=!0,l.value.lockScroller()})}),{nodeVariables:s,menuHide:g,menuStart:m,viewLog:a}}function We(n){const{graph:l}=n,s=J(),g=L([]),{t:m}=Z(),a=xe(),c=(h,i,t)=>{var u,p;const o=_e(m)[i],r=(u=l.value)==null?void 0:u.getCellById(h);if(r){r.removeMarkup(),r.setMarkup(be.markup.concat(Me));const d=(p=l.value)==null?void 0:p.findViewByCell(r),N=d==null?void 0:d.find("div")[0],E=ge(Ie,{t:m,taskInstance:t,stateProps:o});ve(E,N)}};return{taskList:g,refreshTaskStatus:()=>{const h=Number(s.params.projectCode),i=Number(s.params.id);je(i,h).then(t=>{window.$message.success(m("project.workflow.refresh_status_succeeded")),g.value=t.taskList,g.value&&g.value.forEach(o=>{c(o.taskCode,o.state,o),o.dependentResult&&a.updateDependentResult(JSON.parse(o.dependentResult))})})}}}const ze={instance:{type:Object,default:void 0},definition:{type:Object,default:void 0},readonly:{type:Boolean,default:!1},projectCode:{type:Number,default:0}};var ln=ke({name:"workflow-dag",props:ze,emits:["refresh","save"],setup(n,l){const{t:s}=Z(),g=J(),m=Te();z("readonly",j(n,"readonly"));const a=L();z("graph",a);const{visible:c,toggle:k,formValue:h,formRef:i,submit:t,cancel:o}=Se({graph:a}),{taskConfirm:r,taskModalVisible:u,currTask:p,taskCancel:d,appendTask:N,editTask:E,copyTask:I,processDefinition:b,removeTasks:V}=Fe({graph:a,definition:j(n,"definition")}),{nodeVariables:e,menuHide:T,menuStart:f,viewLog:C}=Ke({graph:a}),S=Y(()=>n.definition?g.name==="workflow-definition-detail"&&n.definition.processDefinition.releaseState==="NOT_RELEASE":!1),y=Y(()=>n.instance?n.instance.state!=="WAITING_THREAD"&&n.instance.state!=="SUCCESS"&&n.instance.state!=="PAUSE"&&n.instance.state!=="FAILURE"&&n.instance.state!=="STOP":n.definition?n.definition.processDefinition.releaseState==="ONLINE":!1),U=Y(()=>{if(e.menuCell){const v=Number(e.menuCell.id);return q.value.find(w=>w.taskCode===v)}else return}),P=L();x(()=>u.value,()=>{if(n.instance&&u.value){const v=p.value.code;P.value=q.value.find(w=>w.taskCode===v)}});const A=L(),{taskList:q,refreshTaskStatus:O}=We({graph:a}),{onDragStart:te,onDrop:oe}=qe({graph:a,readonly:j(n,"readonly"),appendTask:N});Je({graph:a,definition:j(n,"definition")});const R=L(!1),ne=v=>{typeof v=="boolean"?R.value=v:R.value=!R.value},se=()=>{l.emit("refresh"),R.value=!1},_=L(!1),B=v=>{typeof v=="boolean"?_.value=v:_.value=!R.value},{getConnects:ae,getLocations:ie}=Ge(),re=v=>{var K,W;const w=((K=a.value)==null?void 0:K.getEdges())||[],H=((W=a.value)==null?void 0:W.getNodes())||[];if(!H.length){window.$message.error(s("project.dag.node_not_created")),B(!1);return}const fe=ae(H,w,b.value.taskDefinitionList),me=ie(H);l.emit("save",{taskDefinitions:b.value.taskDefinitionList,saveForm:v,connects:fe,locations:me}),B(!1)},F=(v,w)=>{u.value=!1,C(v,w),X()},X=()=>{const{state:v}=De(Ye({taskInstanceId:e.logTaskId,limit:e.limit,skipLineNum:e.skipLineNum}).then(w=>{w.message?(e.logRef+=w.message,e.limit+=1e3,e.skipLineNum+=w.lineNum,X()):e.logLoadingRef=!1}),{});return v},le=()=>{e.logRef="",e.limit=1e3,e.skipLineNum=0,X()},ue=()=>{$.downloadFile("log/download-log",{taskInstanceId:e.logTaskId})},ce=()=>{e.showModalRef=!1},de=()=>{t(),n.instance&&O()};return x(()=>n.definition,()=>{n.instance&&(O(),A.value=setInterval(()=>O(),9e4))}),x(()=>e.showModalRef,()=>{e.showModalRef||(e.row={},e.logRef="",e.logLoadingRef=!0,e.skipLineNum=0,e.limit=1e3)}),he(()=>clearInterval(A.value)),()=>D("div",{class:[G.dag,G[`dag-${m.darkTheme?"dark":"light"}`]]},[D(Ce,{layoutToggle:k,instance:n.instance,definition:n.definition,onVersionToggle:ne,onSaveModelToggle:B,onRemoveTasks:V,onRefresh:O},null),D("div",{class:G.content},[D(Le,{onDragStart:te},null),D(Ne,{onDrop:oe},null)]),D(ye,{visible:c.value,submit:de,cancel:o,formValue:h,formRef:i},null),!!n.definition&&D(Ue,{isInstance:!!n.instance,row:n.definition.processDefinition,"onUpdate:row":v=>n.definition.processDefinition=v,show:R.value,"onUpdate:show":v=>R.value=v,onUpdateList:se},null),D(Be,{show:_.value,"onUpdate:show":v=>_.value=v,onSave:re,definition:n.definition,instance:n.instance},null),D(Ae,{readonly:n.readonly,show:u.value,projectCode:n.projectCode,processInstance:n.instance,taskInstance:P.value,onViewLog:F,data:p.value,definition:b,onSubmit:r,onCancel:d},null),D(we,{startReadonly:S.value,menuReadonly:y.value,taskInstance:U.value,cell:e.menuCell,visible:e.menuVisible,left:e.pageX,top:e.pageY,onHide:T,onStart:f,onEdit:E,onCopyTask:I,onRemoveTasks:V,onViewLog:F},null),!!n.definition&&D(Xe,{row:n.definition.processDefinition,"onUpdate:row":v=>n.definition.processDefinition=v,show:e.startModalShow,"onUpdate:show":v=>e.startModalShow=v,taskCode:e.taskCode},null),!!n.instance&&D(He,{showModalRef:e.showModalRef,logRef:e.logRef,row:e.row,showDownloadLog:!0,logLoadingRef:e.logLoadingRef,onConfirmModal:ce,onRefreshLogs:le,onDownloadLogs:ue},null)])}});export{ln as default};
