CREATE TABLE TMP_IP_SUMMARY(IP STRING, TOTAL INT) PARTITIONED BY (DS STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t';

INSERT INTO TABLE TMP_IP_SUMMARY PARTITION (ds = '2015-08-19') SELECT v.IP, COUNT(v.IP) AS total FROM VDN_LOGS_FULLY v LEFT JOIN (SELECT DISTINCT ip FROM VDN_LOGS_FULLY WHERE ds='2015-08-19' and err='303000') a ON v.IP = a.IP WHERE v.ds='2015-08-19' and v.ERR='208000' AND a.ip IS NULL GROUP BY v.IP;

INSERT INTO TABLE TMP_VDN_LOGS_FULLY PARTITION (ds = '2015-08-19') SELECT v.ERR , v.IP , v.REF , v.SID , v.UID , v.LOC , v.CAT , v.TM , v.URL , v.DUR , v.BT , v.BL , v.LT , v.VID , v.PTYPE , v. CDNID , v.NETNAME , v.TR , v.ISP STRING , COUNTRY , v.CITY STRING FROM VDN_LOGS_FULLY v WHERE v.ds = '2015-08-19' AND v.IP IN (select ip from tmp_ip_summary where total > 5);

sqoop export --connect jdbc:mysql://114.80.177.146:3306/vdn_dashboard --table TMP_VDN_LOGS_FULLY  \
    --export-dir hdfs://centos136.thinker.cn:8020/user/cloudland/vdnlogs/TMP_VDN_LOGS_FULLY/ds=2015-08-19 --validate --input-null-string '\\N'  --input-null-non-string '\\N' \
    --username vdnuser -password Ifeng01 --input-fields-terminated-by "\t"
	
-- CREATE TABLE IFENG IP REPOSITORY.
CREATE EXTERNAL TABLE VDN_IP_REPO(IP STRING, ISP STRING, COUNTRY STRING, CITY STRING) PARTITIONED BY (DS STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t' LOCATION 'hdfs://ubuntu144.thinker.cn:9000/user/cloudland/vdn/all'; 
CREATE EXTERNAL TABLE VDN_IP_REPO_CN(IP STRING, ISP STRING, COUNTRY STRING, CITY STRING) PARTITIONED BY (DS STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t' LOCATION 'hdfs://ubuntu144.thinker.cn:9000/user/cloudland/vdn/CN'; 
CREATE EXTERNAL TABLE VDN_IP_REPO_US(IP STRING, ISP STRING, COUNTRY STRING, CITY STRING) PARTITIONED BY (DS STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t' LOCATION 'hdfs://ubuntu144.thinker.cn:9000/user/cloudland/vdn/US'; 
CREATE EXTERNAL TABLE VDN_IP_REPO_CAN(IP STRING, ISP STRING, COUNTRY STRING, CITY STRING) PARTITIONED BY (DS STRING) ROW FORMAT DELIMITED FIELDS TERMINATED BY '\t' LOCATION 'hdfs://ubuntu144.thinker.cn:9000/user/cloudland/vdn/CAN'; 


LOAD DATA INPATH 'hdfs://ubuntu144.thinker.cn:9000/user/cloudland/vdnlogs/input/vdn_cn/part-r-00000' INTO TABLE VDN_IP_REPO_CN PARTITION (ds ='2015-07-28');